version: '3.7'

services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
      cache_from:
      - primo-explore-eluna-workshop
      - quay.io/nyulibraries/eluna-2019-devday-advanced-workshop:pt-3
      - quay.io/nyulibraries/eluna-2019-devday-advanced-workshop:latest
    image: primo-explore-eluna-workshop:pt-3
    environment:
      PROXY_SERVER: http://bobcatdev.library.nyu.edu:80
      VIEW: NYU
    ports:
    - 8003:8003
    - 3001:3001
    volumes:
    - ./primo-explore/custom:/app/primo-explore/custom/

  create-package:
    image: primo-explore-eluna-workshop:pt-3
    environment:
      PROXY_SERVER: http://bobcatdev.library.nyu.edu:80
      VIEW: NYU
    ports:
    - 8003:8003
    - 3001:3001
    command: yarn create-package
    volumes:
    - ./primo-explore/custom:/app/primo-explore/custom/
    - ./packages:/app/packages/

  e2e:
    image: primo-explore-eluna-cypress
    build:
      cache_from:
      - primo-explore-eluna-cypress
      - quay.io/nyulibraries/eluna-2019-devday-advanced-workshop:e2e
      context: ./e2e-cypress
    depends_on:
    - web